name: Release

on:
  release:
    types: [ published ]

jobs:
  release:
    runs-on: [ ubuntu-latest, macos-10.15 ]
    env:
      LC_ALL: C.UTF-8
      LANG: C.UTF-8
    steps:
      - uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.6
      - name: Upgrade pip
        run: python -m pip install --upgrade pip setuptools==44.0.0
      - name: Print info about the current python installation
        run: make ci-info
      - name: Install requirements
        run: make bootstrap-dev-plugins
      - name: Run tests
        run: make tests
      - name: Create bundle
        run: make bundle
      - name: Test bundle
        run: make ci-test-bundle
      - name: Get release description
        id: release-description
        run: |
          make release-description
          cat release_description.md
          echo "::set-output name=text::$(cat release_description.md)"
        shell: bash
      - name: Get release file name
        id: release-file
        run: echo "::set-output name=filename::tutor-$(uname -s)_$(uname -m)"
        shell: bash
      - name: Debug release variables
        run: |
          echo "Publish file '${{ steps.release-file.outputs.filename }}' to release ${{ github.ref }}"
          echo "================"
          echo "${{ steps.release-description.outputs.text }}"
      - name: Upload bundle
        # https://github.com/marketplace/actions/upload-files-to-a-github-release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ./dist/tutor
          asset_name: "${{ steps.release-file.outputs.filename }}"
          tag: ${{ github.ref }}
          overwrite: true
          body: "${{ steps.release-description.outputs.text }}"
